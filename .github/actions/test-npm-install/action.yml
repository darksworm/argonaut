name: test-npm-install
description: Install Argonaut from npm and verify it runs

inputs:
  node-version:
    description: Node.js version to use
    required: true
  package-name:
    description: "Package name to install (default: argonaut)"
    required: false
    default: argonaut
  package-version:
    description: "Tag or version to install (e.g., v1.16.0 or 1.16.0)"
    required: true
  dist-tag:
    description: "npm dist-tag to install (e.g., next). If provided, overrides package-version."
    required: false
    default: ""
  test-mode:
    description: Reserved
    required: false
    default: release

runs:
  using: composite
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        registry-url: 'https://registry.npmjs.org'

    - name: Normalize version
      id: ver
      shell: bash
      run: |
        VER="${{ inputs.package-version }}"
        VER="${VER#v}"
        echo "version=$VER" >> "$GITHUB_OUTPUT"

    - name: Wait for package availability and install
      shell: bash
      run: |
        set -euo pipefail
        NAME="${{ inputs.package-name }}"

        # Determine target version/tag
        if [ -n "${{ inputs.dist-tag }}" ]; then
          TARGET="$NAME@${{ inputs.dist-tag }}"
        else
          TARGET="$NAME@${{ steps.ver.outputs.version }}"
        fi

        # Wait for package to be available (retry up to 10 times with 30s intervals)
        echo "Waiting for package $TARGET to be available..."
        for i in {1..10}; do
          if npm view "$TARGET" version >/dev/null 2>&1; then
            echo "Package $TARGET is available!"
            break
          fi
          echo "Attempt $i/10: Package not yet available, waiting 30 seconds..."
          sleep 30
        done

        # Install the package
        echo "Installing $TARGET globally..."
        npm i -g "$TARGET"

        # Add npm global bin to PATH
        NPM_BIN_PATH=$(npm bin -g)
        echo "$NPM_BIN_PATH" >> $GITHUB_PATH
        export PATH="$NPM_BIN_PATH:$PATH"

        # Test the installation
        echo "Testing argonaut installation..."
        which argonaut
        argonaut --version

        # Basic smoke test: print help
        echo "Running smoke test..."
        argonaut --help >/dev/null
        echo "âœ… All tests passed!"
