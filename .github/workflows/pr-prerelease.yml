name: PR Pre-release Build

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  packages: write

jobs:
  check-release-pr:
    runs-on: ubuntu-latest
    # Run on release-please PRs OR when darksworm comments /prerelease on any PR
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       github.event.comment.user.login == 'darksworm' &&
       contains(github.event.comment.body, '/prerelease'))
    outputs:
      is_release_pr: ${{ steps.check.outputs.is_release_pr }}
      should_build: ${{ steps.check.outputs.should_build }}
      pr_ref: ${{ steps.check.outputs.pr_ref }}
      pr_sha: ${{ steps.check.outputs.pr_sha }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Get PR details for comment trigger
        id: pr-details
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);
            core.setOutput('title', pr.data.title);

      - name: Check if this is a release-please PR or manual trigger
        id: check
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_PR_REF: ${{ steps.pr-details.outputs.ref }}
          COMMENT_PR_SHA: ${{ steps.pr-details.outputs.sha }}
        run: |
          if [[ "$EVENT_NAME" == "issue_comment" ]]; then
            # Manual trigger via /prerelease comment (already verified actor is darksworm)
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "is_release_pr=false" >> $GITHUB_OUTPUT
            echo "pr_ref=$COMMENT_PR_REF" >> $GITHUB_OUTPUT
            echo "pr_sha=$COMMENT_PR_SHA" >> $GITHUB_OUTPUT
            echo "pr_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "Manual pre-release build requested via comment"
          else
            # Check if this is a release-please PR by branch name and title pattern
            echo "pr_ref=$PR_HEAD_REF" >> $GITHUB_OUTPUT
            echo "pr_sha=$PR_HEAD_SHA" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            if [[ "$PR_HEAD_REF" =~ ^release-please--branches--main ]] && [[ "$PR_TITLE" =~ ^chore\(main\):\ release ]]; then
              echo "is_release_pr=true" >> $GITHUB_OUTPUT
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "Detected release-please PR: $PR_TITLE"
            else
              echo "is_release_pr=false" >> $GITHUB_OUTPUT
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "Not a release-please PR - Branch: $PR_HEAD_REF, Title: $PR_TITLE"
            fi
          fi

  build-prerelease:
    needs: check-release-pr
    if: needs.check-release-pr.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    outputs:
      pre_version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ needs.check-release-pr.outputs.pr_sha }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create snapshot version
        id: version
        env:
          IS_RELEASE_PR: ${{ needs.check-release-pr.outputs.is_release_pr }}
          PR_REF: ${{ needs.check-release-pr.outputs.pr_ref }}
        run: |
          # Extract version from release-please PR title and add -dev suffix
          if [[ "$IS_RELEASE_PR" == "true" ]]; then
            # Extract version from branch name
            BASE_VERSION=$(echo "$PR_REF" | grep -oP '[0-9]+\.[0-9]+\.[0-9]+' || echo "")
            if [[ -z "$BASE_VERSION" ]]; then
              VERSION="dev-snapshot-$(git rev-parse --short HEAD)"
            else
              VERSION="${BASE_VERSION}-dev-rc.$(git rev-parse --short HEAD)"
            fi
          else
            VERSION="dev-snapshot-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building pre-release version: $VERSION"

      - name: Run GoReleaser release with dev tags (no publishing)
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: nightly
          args: release --config .goreleaser.release.yml --snapshot --clean --skip=aur,nix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug GoReleaser output
        run: |
          echo "=== Contents of dist/ directory ==="
          find dist/ -type f -ls || true
          echo "=== All files by name ==="
          find dist/ -type f -name "*" | sort || true

      - name: Package artifacts
        run: |
          mkdir -p pr-artifacts

          # Copy binaries from GoReleaser build directories with proper naming
          find dist/ -path "*/go-standard_*" -name "argonaut" -type f | while read file; do
            # Extract platform info from path
            platform_dir=$(basename $(dirname "$file"))
            # go-standard_darwin_amd64_v1 -> darwin-amd64
            platform=$(echo "$platform_dir" | sed 's/go-standard_//; s/_v[0-9.]*$//')
            platform_clean=$(echo "$platform" | sed 's/_/-/g')
            cp "$file" "pr-artifacts/argonaut-${platform_clean}"
            echo "Copied: $file -> pr-artifacts/argonaut-${platform_clean}"
          done

          # Copy packages
          find dist/ -name "*.deb" -exec cp {} pr-artifacts/ \; 2>/dev/null || true
          find dist/ -name "*.rpm" -exec cp {} pr-artifacts/ \; 2>/dev/null || true
          find dist/ -name "*.apk" -exec cp {} pr-artifacts/ \; 2>/dev/null || true

          # Create checksums
          cd pr-artifacts
          echo "=== Files copied to pr-artifacts ==="
          ls -la
          if [ "$(ls -A)" ]; then
            shasum -a 256 * > checksums.txt
          else
            echo "No files found!" > checksums.txt
          fi
          cd ..

      - name: Upload Linux binaries
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries-${{ steps.version.outputs.version }}
          path: pr-artifacts/argonaut-linux-*
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload macOS binaries
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries-${{ steps.version.outputs.version }}
          path: pr-artifacts/argonaut-darwin-*
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload DEB packages
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-${{ steps.version.outputs.version }}
          path: pr-artifacts/*.deb
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload RPM packages
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-${{ steps.version.outputs.version }}
          path: pr-artifacts/*.rpm
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload APK packages
        uses: actions/upload-artifact@v4
        with:
          name: apk-packages-${{ steps.version.outputs.version }}
          path: pr-artifacts/*.apk
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums-${{ steps.version.outputs.version }}
          path: pr-artifacts/checksums.txt
          retention-days: 30

      - name: Comment on PR with download link
        uses: actions/github-script@v7
        env:
          PRE_VERSION: ${{ steps.version.outputs.version }}
          PR_NUMBER: ${{ needs.check-release-pr.outputs.pr_number }}
        with:
          script: |
            const fs = require('fs');
            const version = process.env.PRE_VERSION;

            // List artifacts in pr-artifacts directory
            const artifactFiles = fs.readdirSync('pr-artifacts').filter(f => f !== 'checksums.txt');
            const checksums = fs.readFileSync('pr-artifacts/checksums.txt', 'utf8');

            // Generate download links for categorized artifacts
            const baseUrl = `https://nightly.link/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Categorize files
            const linuxBinaries = artifactFiles.filter(f => f.includes('linux') || (f === 'argonaut' && !f.includes('darwin')));
            const macosBinaries = artifactFiles.filter(f => f.includes('darwin') || f.includes('macos'));
            const debPackages = artifactFiles.filter(f => f.endsWith('.deb'));
            const rpmPackages = artifactFiles.filter(f => f.endsWith('.rpm'));
            const apkPackages = artifactFiles.filter(f => f.endsWith('.apk'));

            let downloadLinks = [];

            if (linuxBinaries.length > 0) {
              downloadLinks.push(`- ğŸ§ [Linux Binaries](${baseUrl}/linux-binaries-${version}.zip) (${linuxBinaries.length} files)`);
            }

            if (macosBinaries.length > 0) {
              downloadLinks.push(`- ğŸ [macOS Binaries](${baseUrl}/macos-binaries-${version}.zip) (${macosBinaries.length} files)`);
            }

            if (debPackages.length > 0) {
              downloadLinks.push(`- ğŸ“¦ [DEB Packages](${baseUrl}/deb-packages-${version}.zip) (${debPackages.length} files)`);
            }

            if (rpmPackages.length > 0) {
              downloadLinks.push(`- ğŸ“¦ [RPM Packages](${baseUrl}/rpm-packages-${version}.zip) (${rpmPackages.length} files)`);
            }

            if (apkPackages.length > 0) {
              downloadLinks.push(`- ğŸ“¦ [APK Packages](${baseUrl}/apk-packages-${version}.zip) (${apkPackages.length} files)`);
            }

            const artifactList = downloadLinks.join('\n');

            const repoFullName = `${context.repo.owner}/${context.repo.repo}`;
            const comment = `## ğŸš€ Pre-release Build Available

            A pre-release build has been created for this PR with version \`${version}\`.

            ### ğŸ“¥ Download by Category
            ${artifactList}

            ### ğŸ” Individual Files
            <details>
            <summary>Click to see all ${artifactFiles.length} files</summary>

            ${artifactFiles.map(f => `- \`${f}\``).join('\n')}
            </details>

            ### ğŸ³ Docker Image
            \`\`\`bash
            docker pull ghcr.io/${repoFullName}:${version}
            \`\`\`

            ### ğŸ” Checksums
            <details>
            <summary>Click to expand checksums</summary>

            \`\`\`
            ${checksums}
            \`\`\`
            </details>

            ### ğŸ“‹ Alternative Download
            You can also browse all artifacts from the [Actions tab](https://github.com/${repoFullName}/actions/runs/${context.runId}).

            > **Note:** This is a pre-release build for testing purposes only. The version includes \`-dev\` to clearly indicate it's not an official release.

            ---
            *This comment will be updated on each push to the PR.*`;

            // Find existing comment
            const prNumber = context.issue?.number || Number(process.env.PR_NUMBER);
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸš€ Pre-release Build Available')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
