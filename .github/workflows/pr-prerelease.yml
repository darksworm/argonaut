name: PR Pre-release Build

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  packages: write

jobs:
  check-release-pr:
    runs-on: ubuntu-latest
    outputs:
      is_release_pr: ${{ steps.check.outputs.is_release_pr }}
    steps:
      - name: Check if this is a release-please PR
        id: check
        run: |
          # Check if this is a release-please PR by branch name and title pattern
          if [[ "${{ github.event.pull_request.head.ref }}" =~ ^release-please--branches--main ]] && [[ "${{ github.event.pull_request.title }}" =~ ^chore\(main\):\ release ]]; then
            echo "is_release_pr=true" >> $GITHUB_OUTPUT
            echo "Detected release-please PR: ${{ github.event.pull_request.title }}"
          else
            echo "is_release_pr=false" >> $GITHUB_OUTPUT
            echo "Not a release-please PR - Branch: ${{ github.event.pull_request.head.ref }}, Title: ${{ github.event.pull_request.title }}"
          fi

  build-prerelease:
    needs: check-release-pr
    if: needs.check-release-pr.outputs.is_release_pr == 'true'
    runs-on: ubuntu-latest
    outputs:
      pre_version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create snapshot version
        id: version
        run: |
          # Extract version from release-please PR title and add -dev suffix
          if [[ "${{ github.event.pull_request.head.ref }}" =~ ^release-please--branches--main ]]; then
            # Extract version from PR title: "chore(main): release X.Y.Z"
            BASE_VERSION=$(echo "${{ github.event.pull_request.title }}" | grep -oP 'release \K[0-9]+\.[0-9]+\.[0-9]+' || echo "")
            if [[ -z "$BASE_VERSION" ]]; then
              VERSION="dev-snapshot-$(git rev-parse --short HEAD)"
            else
              VERSION="${BASE_VERSION}-dev-rc.$(git rev-parse --short HEAD)"
            fi
          else
            VERSION="dev-snapshot-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building pre-release version: $VERSION"

      - name: Run GoReleaser release with dev tags (no publishing)
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: nightly
          args: release --config .goreleaser.release.yml --snapshot --clean --skip=aur,nix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug GoReleaser output
        run: |
          echo "=== Contents of dist/ directory ==="
          find dist/ -type f -ls || true
          echo "=== All files by name ==="
          find dist/ -type f -name "*" | sort || true

      - name: Package artifacts
        run: |
          mkdir -p pr-artifacts

          # Copy binaries from GoReleaser build directories with proper naming
          find dist/ -path "*/go-standard_*" -name "argonaut" -type f | while read file; do
            # Extract platform info from path
            platform_dir=$(basename $(dirname "$file"))
            # go-standard_darwin_amd64_v1 -> darwin-amd64
            platform=$(echo "$platform_dir" | sed 's/go-standard_//; s/_v[0-9.]*$//')
            platform_clean=$(echo "$platform" | sed 's/_/-/g')
            cp "$file" "pr-artifacts/argonaut-${platform_clean}"
            echo "Copied: $file -> pr-artifacts/argonaut-${platform_clean}"
          done

          # Copy packages
          find dist/ -name "*.deb" -exec cp {} pr-artifacts/ \; 2>/dev/null || true
          find dist/ -name "*.rpm" -exec cp {} pr-artifacts/ \; 2>/dev/null || true
          find dist/ -name "*.apk" -exec cp {} pr-artifacts/ \; 2>/dev/null || true

          # Create checksums
          cd pr-artifacts
          echo "=== Files copied to pr-artifacts ==="
          ls -la
          if [ "$(ls -A)" ]; then
            shasum -a 256 * > checksums.txt
          else
            echo "No files found!" > checksums.txt
          fi
          cd ..

      - name: Upload Linux binaries
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries-${{ steps.version.outputs.version }}
          path: pr-artifacts/argonaut-linux-*
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload macOS binaries
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries-${{ steps.version.outputs.version }}
          path: pr-artifacts/argonaut-darwin-*
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload DEB packages
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-${{ steps.version.outputs.version }}
          path: pr-artifacts/*.deb
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload RPM packages
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-${{ steps.version.outputs.version }}
          path: pr-artifacts/*.rpm
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload APK packages
        uses: actions/upload-artifact@v4
        with:
          name: apk-packages-${{ steps.version.outputs.version }}
          path: pr-artifacts/*.apk
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums-${{ steps.version.outputs.version }}
          path: pr-artifacts/checksums.txt
          retention-days: 30

      - name: Comment on PR with download link
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const version = '${{ steps.version.outputs.version }}';

            // List artifacts in pr-artifacts directory
            const artifactFiles = fs.readdirSync('pr-artifacts').filter(f => f !== 'checksums.txt');
            const checksums = fs.readFileSync('pr-artifacts/checksums.txt', 'utf8');

            // Generate download links for categorized artifacts
            const baseUrl = `https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            // Categorize files
            const linuxBinaries = artifactFiles.filter(f => f.includes('linux') || (f === 'argonaut' && !f.includes('darwin')));
            const macosBinaries = artifactFiles.filter(f => f.includes('darwin') || f.includes('macos'));
            const debPackages = artifactFiles.filter(f => f.endsWith('.deb'));
            const rpmPackages = artifactFiles.filter(f => f.endsWith('.rpm'));
            const apkPackages = artifactFiles.filter(f => f.endsWith('.apk'));

            let downloadLinks = [];

            if (linuxBinaries.length > 0) {
              downloadLinks.push(`- ğŸ§ [Linux Binaries](${baseUrl}/linux-binaries-${version}.zip) (${linuxBinaries.length} files)`);
            }

            if (macosBinaries.length > 0) {
              downloadLinks.push(`- ğŸ [macOS Binaries](${baseUrl}/macos-binaries-${version}.zip) (${macosBinaries.length} files)`);
            }

            if (debPackages.length > 0) {
              downloadLinks.push(`- ğŸ“¦ [DEB Packages](${baseUrl}/deb-packages-${version}.zip) (${debPackages.length} files)`);
            }

            if (rpmPackages.length > 0) {
              downloadLinks.push(`- ğŸ“¦ [RPM Packages](${baseUrl}/rpm-packages-${version}.zip) (${rpmPackages.length} files)`);
            }

            if (apkPackages.length > 0) {
              downloadLinks.push(`- ğŸ“¦ [APK Packages](${baseUrl}/apk-packages-${version}.zip) (${apkPackages.length} files)`);
            }

            const artifactList = downloadLinks.join('\n');

            const comment = `## ğŸš€ Pre-release Build Available

            A pre-release build has been created for this PR with version \`${version}\`.

            ### ğŸ“¥ Download by Category
            ${artifactList}

            ### ğŸ” Individual Files
            <details>
            <summary>Click to see all ${artifactFiles.length} files</summary>

            ${artifactFiles.map(f => `- \`${f}\``).join('\n')}
            </details>

            ### ğŸ³ Docker Image
            \`\`\`bash
            docker pull ghcr.io/${{ github.repository }}:${version}
            \`\`\`

            ### ğŸ” Checksums
            <details>
            <summary>Click to expand checksums</summary>

            \`\`\`
            ${checksums}
            \`\`\`
            </details>

            ### ğŸ“‹ Alternative Download
            You can also browse all artifacts from the [Actions tab](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).

            > **Note:** This is a pre-release build for testing purposes only. The version includes \`-dev\` to clearly indicate it's not an official release.

            ---
            *This comment will be updated on each push to the PR.*`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸš€ Pre-release Build Available')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
